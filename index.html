
<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Scheduler</title> 
	<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
	<script src="/scheduler/assets/js/knockout.js"></script>
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<style type="text/css">
	body { font-family: arial; margin: 0;}
	section { float: left; width: 220px; margin: 5px; padding: 10px; box-sizing: border-box; background: #EEE;}
	ul { padding: 0; list-style: none;}
	h1 { margin: 0 0 10px; text-align: center; font-size: 18px}
	.day>strong { font-size: 14px; border-bottom: 1px solid #AAA; display: block; padding: 10px 10px 3px; margin: 0 -10px 10px; }
	.day>strong span { float: right; color: #777;}
	.users { float: left; margin: -5px;}
	.tasks { height: 200px; margin: 3px 0; border: 1px dashed #555;}
	.task { cursor: pointer; box-sizing: border-box; background: #CCC; font-size: 12px;}
	.task>div { padding: 8px;}
	.task:nth-child(2n) { background: #AAA;}
	.tickets { margin: -5px; font-size: 14px; background: #CCC; padding: 20px 15px 10px; margin-right: 10px;}
	.ticket { cursor: pointer; box-sizing: border-box; margin: 1px 0; background: #AAA; color: #FFF; font-size: 12px; padding: 8px;}
	.ticket:nth-child(2n) { background: #888;}
	.task.complete { background: lightgreen;}
	.users-summary { position: fixed; left: 230px;}
	.ui-resizable { position: relative;}
	.ui-resizable-handle { position: absolute;font-size: 0.1px;z-index: 99999; display: block;}
	.ui-resizable-disabled .ui-resizable-handle, .ui-resizable-autohide .ui-resizable-handle { display: none; }
	.ui-resizable-s { cursor: s-resize; height: 7px; width: 100%; bottom: -5px; left: 0px; }
	</style>
</head>
<body>
	<div class="container" data-bind="style: { width: (users().length+1)*260 + 'px' }">
		<section class="tickets" data-bind="visible: tickets().length">
			<h1>Tickets</h1>
			<ul data-bind="foreach: tickets">
				<li class="ticket" data-bind="draggable: { connectToSortable: '.tasks'}, css: 'ticket-' + id, text: summary"></li>
			</ul>
			<button data-bind="click: newTicket">New</button>
		</section>
		<div class="users" data-bind="foreach: users">
			<section>
				<h1 data-bind="text: name"></h1>
				<div class="days" data-bind="foreach: $root.visibleDays">
					<div class="day" data-bind="css: date.getDate()">
						<strong data-bind="html: date.toDateString() + ' <span>(' + $parent.totalEstimatedTime($data.date) + ')</span>'"></strong>
						<!-- ko foreach: timePeriods -->
						<ul class="tasks" data-bind="sortable: {}, css: $data.getHours() == 9? 'am' : 'pm', foreach: $parents[1].tasksByDay($data)">
							<li class="task" data-bind="resizable: {}, doubleClick: fillTime, style: {height: size()}, css: 'task-' + id, css: getStatus().toLowerCase()">
								<div>
									<strong data-bind="text: ticket.summary + ' (' + estimatedTime() + 'hrs)'"></strong>
									<div data-bind="text: getStatus()"></div>
								</div>
							</li>
						</ul>
						<!-- /ko -->
					</div>
				</div>
			</section>
		</div>
	</div>
	<script src="/scheduler/assets/js/classes.js"></script>
	<script>
	var scheduler = {
		visibleDays: ko.observableArray([]),
		tickets: ko.observableArray([]),
		users: ko.observableArray([]),
		newTicket: function() {
			this.tickets.push(new Ticket({
				summary: 'New ticket - this would be populated by a lightbox prompt'
			}));
		}
	}

	$.getJSON('data.json', function(data) {
		scheduler.visibleDays((data.days || []).map(function(date) {
			return new Day(new Date(date));
		}));
		scheduler.tickets((data.tickets || []).map(function(ticket) {
			return new Ticket(ticket);
		}));
		Task.prototype.taskStatuses = data.taskStatuses;
		scheduler.users((data.users || []).map(function(user) {
			user.tasks = (user.tasks || []).map(function(task) {
				task.ticket = ko.utils.arrayFirst(scheduler.tickets(), function(ticket) {
					return ticket.id == task.project_uid;
				});
				return new Task(task);
			});
			return new User(user);
		}));
	}).fail(function() {
		alert('Could not find a data.json file, or there was a problem with the JSON file.');
	});

	ko.bindingHandlers.sortable = {
		init: function(element, valueAccessor, allBindingsAccessor, viewModel, context) {
			$(element).sortable($.extend({
				connectWith: '.' + element.className, 
				revert: 50, 
				scroll: false,
				receive: function(event, ui) {
					var moveTo = context.$parents[1];
					var date = viewModel;
					if (ui.item.hasClass('ticket')) {
						var ticket = ko.dataFor(ui.item[0]);
						var task = new Task({
							ticket: ticket,
							uid: 999,
							date: date,
							task_status_uid: 1,
						});
					} else {
						var task = ko.dataFor(ui.item[0]);
						var moveFrom = ko.contextFor(ui.sender[0]).$parents[1];
						task.date = date;
						moveFrom.tasks.remove(task);
						ui.item.remove();
					}
					moveTo.tasks.push(task);
				},
				stop: function(event, ui) {
					if (ui.item.hasClass('ticket'))
						ui.item.remove();
				}
			}, valueAccessor()));
		}
	}

	ko.bindingHandlers.draggable = {
		init: function(element, valueAccessor) {
			$(element).draggable($.extend({
				helper: "clone",
				revert: "invalid",
				start: function(event, ui) {
					ui.helper.width($(this).width());
				}
			}, valueAccessor()));
		}
	};

	ko.bindingHandlers.resizable = {
		init: function(element, valueAccessor, allBindingsAccessor, viewModel) {
			$(element).resizable($.extend({
				maxHeight: 200,
				handles: 's',
				grid: [0, 25],
				resize: function() {
					var height = $(this).height();
					viewModel.estimatedTime(height / 50);
				}
			}, valueAccessor()))
		},
		update: function(el, value, all, model, context) {
			var maxHours = 4 - context.$parents[2].totalEstimatedTime(context.$parent) + model.estimatedTime()
			$(el).resizable('option', 'maxHeight', maxHours * 50);
		}
	};

	ko.bindingHandlers.doubleClick = {
		init: function(element, valueAccessor, allBindingsAccessor, viewModel) {
			$(element).dblclick(function() {
				valueAccessor().call(viewModel);
			});
		}
	};

	ko.applyBindings(scheduler);
	</script>
</body>
</html>
