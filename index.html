
<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Schedule - Basic CMS</title>
  	<link rel="stylesheet" type="text/css" href="/assets/css/jquery.fancybox.css?v=2.1.2" media="screen" />

	<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
	<!--<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>-->
	<script type="text/javascript" src="/assets/js/jquery.fancybox.pack.js?v=2.1.3"></script>
	<script src="/scheduler/assets/js/knockout.js"></script>
	<style type="text/css">
	</style>
</head>
<body>
	<div class="container">
		<section class="tickets" data-bind="visible: tickets().length">
			<h1>Tickets</h1>
			<ul data-bind="foreach: tickets">
				<li class="ticket" data-bind="css: 'ticket-' + id, text: summary"></li>
			</ul>
		</section>
		<div class="users" data-bind="foreach: users">
			<section>
				<h1 data-bind="text: name"></h1>
				<div class="days" data-bind="foreach: $root.visibleDays">
					<div class="day" data-bind="css: date.getDate()">
						<strong data-bind="text: date.toDateString()"></strong>
						<!-- ko foreach: [9, 13]-->
						<ul class="tasks" data-bind="css: $data == 9? 'am' : 'pm', foreach: $parent.tasks($parents[1], $data)">
							<li class="task" data-bind="text: ticket.summary, style: {fontSize: size()}, css: 'task-' + id"></li>
						</ul>
						<!-- /ko -->
					</div>
				</div>
			</section>
		</div>
	</div>
	<script>

	function Task(data)
	{
		var self = this;
		this.id = data.uid || 0;
		this.ticket = data.ticket || {};
		this.estimatedTime = ko.observable(data.estimatedTime || 1);
		this.date = new Date(data.date) || new Date();
		this.size = function() {
			return (self.estimatedTime() * 10) + 'px';
		}
	}

	function Ticket(data)
	{
		this.id = data.uid || 0;
		this.summary = data.summary;
	}

	function User(data)
	{
		this.name = data.name;
		this.tasks = ko.observableArray(data.tasks);
	}

	function Day(date)
	{
		var self = this;
		this.date = date;
		this.isSameDay = function(date) {
			return date.toISOString().substr(0, 10) == self.date.toISOString().substr(0, 10);
		}
		this.tasks = function(user, hour) {
			return ko.utils.arrayFilter(user.tasks(), function(task) {
				return self.isSameDay(task.date) && (!hour || task.date.getHours() == hour)
			});
		};
	}

	var scheduler = {
		visibleDays: ko.observableArray([]),
		tickets: ko.observableArray([]),
		users: ko.observableArray([])
	}

	$.getJSON('data.json', function(data) {
		scheduler.visibleDays(data.days.map(function(date) {
			return new Day(new Date(date));
		}));
		scheduler.tickets(data.tickets.map(function(ticket) {
			return new Ticket(ticket);
		}));
		scheduler.users(data.users.map(function(user) {
			user.tasks = (user.tasks || []).map(function(task) {
				task.ticket = ko.utils.arrayFirst(scheduler.tickets(), function(ticket) {
					return ticket.id == task.project_uid;
				});
				return new Task(task);
			});
			return new User(user);
		}));
	});

	ko.applyBindings(scheduler);
	</script>
</body>
</html>
